main:
  set x, 0x8000
  set y, 84
  set a, 1
  hwi 0

update:
  add [px], [vx]
  add [py], [vy]
  add [pz], [vz]

  set a, px
  set b, vx
  jsr clip_coordinate_above
  jsr clip_coordinate_below

  set a, py
  set b, vy
  jsr clip_coordinate_above
  jsr clip_coordinate_below

  set a, pz
  set b, vz
  jsr clip_coordinate_above
  jsr clip_coordinate_below

  set i, 0x8000
  set j, boxes
  jsr display_boxes
  jsr display_boundary

  set pc, update

clip_coordinate_above:
  ife [a], 223
    set pc, pop
  ifu [a], 223
    set pc, pop
  set [a], 223
  mli [b], -1
  set pc, pop

clip_coordinate_below:
  ife [a], 0
    set pc, pop
  ifa [a], 0
    set pc, pop
  set [a], 0
  mli [b], -1
  set pc, pop

display_boxes:
  ife j, boxes_end
    set pc, pop
  set a, [py]
  shl a, 8
  set b, [px]
  and b, 0x00FF
  bor a, b
  add a, [j]
  sti [i], a
  set a, [pz]
  and a, 0x00FF
  add a, [j]
  sti [i], a
  set pc, display_boxes

display_boundary:
  ife j, boundary_end
    set pc, pop
  sti [i], [j]
  set pc, display_boundary

px: .data 0
py: .data 0
pz: .data 0
vx: .data 1
vy: .data 2
vz: .data 3

boxes:
.data 0x0000, 0x0700,
      0x2000, 0x0700,
      0x2020, 0x0700,
      0x0020, 0x0700,
      0x0000, 0x0700,

      0x0000, 0x0720,
      0x0000, 0x0700,
      0x2000, 0x0700,
      0x2000, 0x0720,
      0x2020, 0x0720,
      0x2020, 0x0700,
      0x0020, 0x0700,
      0x0020, 0x0720,

      0x0000, 0x0720,
      0x2000, 0x0720,
      0x2020, 0x0720,
      0x0020, 0x0720,
      0x0000, 0x0720,
      0x0000, 0x0020,

      0x3000, 0x0000,
      0x3000, 0x0700,
      0x5000, 0x0700,
      0x5020, 0x0700,
      0x3020, 0x0700,
      0x3000, 0x0700,

      0x3000, 0x0720,
      0x3000, 0x0700,
      0x5000, 0x0700,
      0x5000, 0x0720,
      0x5020, 0x0720,
      0x5020, 0x0700,
      0x3020, 0x0700,
      0x3020, 0x0720,

      0x3000, 0x0720,
      0x5000, 0x0720,
      0x5020, 0x0720,
      0x3020, 0x0720,
      0x3000, 0x0720,
      0x3000, 0x0020
boxes_end:

boundary:
.data 0x0000, 0x0000,
      0x0000, 0x0700,
      0x2000, 0x0700,
      0x2000, 0x0000,
      0xDF00, 0x0000,
      0xDF00, 0x0700,
      0xFF00, 0x0700,
      0xFF20, 0x0700,
      0xFF20, 0x0000,
      0xFFDF, 0x0000,
      0xFFDF, 0x0700,
      0xFFFF, 0x0700,
      0xDFFF, 0x0700,
      0xDFFF, 0x0000,
      0x20FF, 0x0000,
      0x20FF, 0x0700,
      0x00FF, 0x0700,
      0x00DF, 0x0700,
      0x00DF, 0x0000,
      0x0020, 0x0000,
      0x0020, 0x0700,
      0x0000, 0x0700,
      0x0000, 0x0000,

      0x0000, 0x00FF,
      0x0000, 0x07FF,
      0x2000, 0x07FF,
      0x2000, 0x00FF,
      0xDF00, 0x00FF,
      0xDF00, 0x07FF,
      0xFF00, 0x07FF,
      0xFF20, 0x07FF,
      0xFF20, 0x00FF,
      0xFFDF, 0x00FF,
      0xFFDF, 0x07FF,
      0xFFFF, 0x07FF,
      0xDFFF, 0x07FF,
      0xDFFF, 0x00FF,
      0x20FF, 0x00FF,
      0x20FF, 0x07FF,
      0x00FF, 0x07FF,
      0x00DF, 0x07FF,
      0x00DF, 0x00FF,
      0x0020, 0x00FF,
      0x0020, 0x07FF,
      0x0000, 0x07FF
boundary_end:
